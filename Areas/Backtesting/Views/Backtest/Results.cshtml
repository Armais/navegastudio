@model BacktestResult
@inject IViewLocalizer L

@{
    ViewData["Title"] = L["PageTitle"].Value;
    var beatsMarket = Model.TotalReturn > Model.BenchmarkReturn;
}

<div class="container mt-4 pt-4" style="margin-top: 70px;">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>@L["Title"]: @Model.Symbol</h2>
        <a asp-area="Backtesting" asp-controller="Backtest" asp-action="Index" class="btn btn-outline-secondary">@L["NewBacktest"]</a>
    </div>

    <!-- Benchmark Banner -->
    <div class="alert @(beatsMarket ? "alert-success" : "alert-danger") d-flex justify-content-between align-items-center mb-4" data-aos="fade-up">
        <div>
            <strong>@Model.StrategyDescription</strong>
            <span class="mx-2">|</span>
            @Model.Symbol
            <span class="mx-2">|</span>
            @Model.StartDate.ToString("MMM dd, yyyy") &ndash; @Model.EndDate.ToString("MMM dd, yyyy")
        </div>
        <div class="text-end">
            <span class="fw-bold">@L["Strategy"]: @Model.TotalReturn.ToString("F2")%</span>
            <span class="mx-1">@L["Vs"]</span>
            <span class="fw-bold">@L["BuyAndHold"]: @Model.BenchmarkReturn.ToString("F2")%</span>
            <span class="badge @(beatsMarket ? "bg-success" : "bg-danger") ms-2">@(beatsMarket ? L["BeatsMarket"] : L["Underperforms"])</span>
        </div>
    </div>

    <!-- Row 1: Core metrics -->
    <div class="row g-3 mb-3" data-aos="fade-up">
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">@L["TotalReturn"]</h6>
                    <h3 class="@(Model.TotalReturn >= 0 ? "text-success" : "text-danger")">@Model.TotalReturn.ToString("F2")%</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">@L["FinalCapital"]</h6>
                    <h3>$@Model.FinalCapital.ToString("N2")</h3>
                    <small class="text-muted">@L["From"] $@Model.InitialCapital.ToString("N2")</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">@L["MaxDrawdown"]</h6>
                    <h3 class="text-warning">@Model.MaxDrawdown.ToString("F2")%</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">@L["SharpeRatio"]</h6>
                    <h3>@Model.SharpeRatio.ToString("F2")</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 2: Performance metrics -->
    <div class="row g-3 mb-3" data-aos="fade-up" data-aos-delay="50">
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">@L["TotalTrades"]</h6>
                    <h4>@Model.TotalTrades</h4>
                    <small class="text-muted">@Model.WinningTrades @L["W"] / @Model.LosingTrades @L["L"]</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">@L["WinRate"]</h6>
                    <h4>@Model.WinRate.ToString("F1")%</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">@L["ProfitFactor"]</h6>
                    <h4 class="@(Model.ProfitFactor >= 1 ? "text-success" : "text-danger")">@Model.ProfitFactor.ToString("F2")</h4>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center shadow-sm">
                <div class="card-body">
                    <h6 class="text-muted">@L["SortinoRatio"]</h6>
                    <h4>@Model.SortinoRatio.ToString("F2")</h4>
                </div>
            </div>
        </div>
    </div>

    <!-- Row 3: Detailed metrics -->
    <div class="row g-3 mb-4" data-aos="fade-up" data-aos-delay="100">
        <div class="col-md-2">
            <div class="card text-center shadow-sm"><div class="card-body py-2">
                <small class="text-muted d-block">@L["AvgWin"]</small>
                <strong class="text-success">$@Model.AvgWin.ToString("N2")</strong>
            </div></div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm"><div class="card-body py-2">
                <small class="text-muted d-block">@L["AvgLoss"]</small>
                <strong class="text-danger">$@Model.AvgLoss.ToString("N2")</strong>
            </div></div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm"><div class="card-body py-2">
                <small class="text-muted d-block">@L["Expectancy"]</small>
                <strong class="@(Model.Expectancy >= 0 ? "text-success" : "text-danger")">$@Model.Expectancy.ToString("N2")</strong>
            </div></div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm"><div class="card-body py-2">
                <small class="text-muted d-block">@L["MaxConsecWins"]</small>
                <strong>@Model.MaxConsecutiveWins</strong>
            </div></div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm"><div class="card-body py-2">
                <small class="text-muted d-block">@L["MaxConsecLosses"]</small>
                <strong>@Model.MaxConsecutiveLosses</strong>
            </div></div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm"><div class="card-body py-2">
                <small class="text-muted d-block">@L["TotalCosts"]</small>
                <strong class="text-warning">$@Model.TotalCommissions.ToString("N2")</strong>
            </div></div>
        </div>
    </div>

    <!-- Equity Curve -->
    <div class="card shadow-sm mb-4" data-aos="fade-up">
        <div class="card-header"><h5 class="mb-0">@L["EquityCurve"]</h5></div>
        <div class="card-body"><canvas id="equityChart" height="100"></canvas></div>
    </div>

    <!-- Drawdown Chart -->
    <div class="card shadow-sm mb-4" data-aos="fade-up">
        <div class="card-header"><h5 class="mb-0">@L["Drawdown"]</h5></div>
        <div class="card-body"><canvas id="drawdownChart" height="80"></canvas></div>
    </div>

    <!-- Trade P&L -->
    <div class="card shadow-sm mb-4" data-aos="fade-up">
        <div class="card-header"><h5 class="mb-0">@L["TradePnL"]</h5></div>
        <div class="card-body"><canvas id="tradesChart" height="80"></canvas></div>
    </div>

    <!-- Trade History -->
    <div class="card shadow-sm mb-4">
        <div class="card-header"><h5 class="mb-0">@L["TradeHistory"]</h5></div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr><th>#</th><th>@L["Col_EntryDate"]</th><th>@L["Col_ExitDate"]</th><th>@L["Col_EntryPrice"]</th><th>@L["Col_ExitPrice"]</th><th>@L["Col_Qty"]</th><th>@Html.Raw(L["Col_PnL"].Value)</th><th>@Html.Raw(L["Col_PnLPct"].Value)</th><th>@L["Col_Type"]</th><th>@L["Col_ExitReason"]</th></tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < Model.Trades.Count; i++)
                        {
                            var trade = Model.Trades[i];
                            var badgeClass = trade.ExitReason switch
                            {
                                "StopLoss" => "bg-danger",
                                "TakeProfit" => "bg-success",
                                "Signal" => "bg-info",
                                "EndOfData" => "bg-warning text-dark",
                                _ => "bg-secondary"
                            };
                            <tr>
                                <td>@(i + 1)</td>
                                <td>@trade.EntryDate.ToString("yyyy-MM-dd")</td>
                                <td>@trade.ExitDate.ToString("yyyy-MM-dd")</td>
                                <td>$@trade.EntryPrice.ToString("F2")</td>
                                <td>$@trade.ExitPrice.ToString("F2")</td>
                                <td>@trade.Quantity</td>
                                <td class="@(trade.ProfitLoss >= 0 ? "text-success" : "text-danger") fw-bold">$@trade.ProfitLoss.ToString("F2")</td>
                                <td class="@(trade.ProfitLossPercent >= 0 ? "text-success" : "text-danger")">@trade.ProfitLossPercent.ToString("F2")%</td>
                                <td><span class="badge bg-info">@trade.Type</span></td>
                                <td><span class="badge @badgeClass">@trade.ExitReason</span></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script>
        const equityLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.EquityCurve.Select(e => e.Date.ToString("yyyy-MM-dd"))));
        const equityData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.EquityCurve.Select(e => e.Equity)));
        const benchmarkData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.BenchmarkCurve.Select(e => e.Equity)));

        new Chart(document.getElementById('equityChart'), {
            type: 'line',
            data: {
                labels: equityLabels,
                datasets: [
                    {
                        label: '@Html.Raw(L["Chart_Strategy"].Value)',
                        data: equityData,
                        borderColor: '#0066CC',
                        backgroundColor: 'rgba(0,102,204,0.1)',
                        fill: true,
                        tension: 0.1,
                        pointRadius: 0,
                        borderWidth: 2
                    },
                    {
                        label: '@Html.Raw(L["Chart_BuyHold"].Value)',
                        data: benchmarkData,
                        borderColor: '#8b949e',
                        borderDash: [6, 3],
                        fill: false,
                        tension: 0.1,
                        pointRadius: 0,
                        borderWidth: 1.5
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#e6edf3' } } },
                scales: {
                    x: { display: true, ticks: { maxTicksLimit: 10, color: '#8b949e' }, grid: { color: '#21262d' } },
                    y: { display: true, ticks: { callback: v => '$' + v.toLocaleString(), color: '#8b949e' }, grid: { color: '#21262d' } }
                }
            }
        });

        // Drawdown chart
        const ddLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DrawdownCurve.Select(e => e.Date.ToString("yyyy-MM-dd"))));
        const ddData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DrawdownCurve.Select(e => e.DrawdownPct)));

        new Chart(document.getElementById('drawdownChart'), {
            type: 'line',
            data: {
                labels: ddLabels,
                datasets: [{
                    label: '@Html.Raw(L["Chart_DrawdownPct"].Value)',
                    data: ddData,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220,53,69,0.15)',
                    fill: true,
                    tension: 0.1,
                    pointRadius: 0,
                    borderWidth: 1.5
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#e6edf3' } } },
                scales: {
                    x: { display: true, ticks: { maxTicksLimit: 10, color: '#8b949e' }, grid: { color: '#21262d' } },
                    y: { display: true, ticks: { callback: v => v.toFixed(1) + '%', color: '#8b949e' }, grid: { color: '#21262d' } }
                }
            }
        });

        // Trade P&L chart
        const tradeLabel = '@Html.Raw(L["Chart_Trade"].Value)';
        const tradeLabels = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Trades.Select((t, i) => i + 1)));
        const tradePnl = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Trades.Select(t => t.ProfitLoss)));

        new Chart(document.getElementById('tradesChart'), {
            type: 'bar',
            data: {
                labels: tradeLabels.map(i => tradeLabel + ' ' + i),
                datasets: [{
                    label: '@Html.Raw(L["Chart_PnL"].Value)',
                    data: tradePnl,
                    backgroundColor: tradePnl.map(v => v >= 0 ? 'rgba(25, 135, 84, 0.7)' : 'rgba(220, 53, 69, 0.7)'),
                    borderColor: tradePnl.map(v => v >= 0 ? '#198754' : '#dc3545'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { labels: { color: '#e6edf3' } } },
                scales: {
                    x: { ticks: { color: '#8b949e' }, grid: { color: '#21262d' } },
                    y: { ticks: { callback: v => '$' + v.toLocaleString(), color: '#8b949e' }, grid: { color: '#21262d' } }
                }
            }
        });
    </script>
}
